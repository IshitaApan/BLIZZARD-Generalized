[Commands] Menu disappears when dialog pops up

When a dialog pops up, a main menu with a visibleWhen clause involving activeEditorId disappears. It can be reproduced with this code: WithExpression w = new WithExpression("activeEditorId"); EqualsExpression e = new EqualsExpression( "org.eclipse.ui.DefaultTextEditor"); w.add(e); IEvaluationReference ref = es.addEvaluationListener(w, listener, "foo"); WorkbenchWindowExpression wwe = new WorkbenchWindowExpression(getSite() .getPage().getWorkbenchWindow()); rs.addEvaluationListener(wwe, new RestrictionListener(ref), IRestrictionService.PROP_NOTIFYING); The active editor source is evaluated before the active shell source, so the foo property changes and then is restricted from posting changes. This will be a problem with all sources that change in uncontrolled orders, I'm not sure what to do here. PW