ClassCastException in WorkbenchPage when showing E4 part using EPartService.showPart

Created attachment 232684 Plugin project that reproduces the bug Prerequisite: 1. Using the PlatformUI.createAndRunWorkbench() method from an IApplication implementation to start a workbench, with a product that has the applicationXMI property pointing to a custom Application.e4xmi file. 2. The Application.e4xmi model must have a PartDescriptor with a handler child. Symptoms: When calling EPartService.showPart(MPart, PartState) to show the part that has a handler, the following exception is shown: ----------------------------------------------------------- java.lang.ClassCastException: org.eclipse.e4.ui.model.application.commands.impl.HandlerImpl cannot be cast to org.eclipse.e4.ui.model.application.ui.MUIElement 	at org.eclipse.ui.internal.WorkbenchPage$5.handleEvent(WorkbenchPage.java:4957) 	at org.eclipse.e4.ui.services.internal.events.UIEventHandler$1.run(UIEventHandler.java:41) 	at org.eclipse.swt.widgets.Synchronizer.syncExec(Synchronizer.java:180) 	at org.eclipse.ui.internal.UISynchronizer.syncExec(UISynchronizer.java:150) 	at org.eclipse.swt.widgets.Display.syncExec(Display.java:4688) 	at org.eclipse.e4.ui.internal.workbench.swt.E4Application$1.syncExec(E4Application.java:205) 	at org.eclipse.e4.ui.services.internal.events.UIEventHandler.handleEvent(UIEventHandler.java:38) 	at org.eclipse.equinox.internal.event.EventHandlerWrapper.handleEvent(EventHandlerWrapper.java:197) 	at org.eclipse.equinox.internal.event.EventHandlerTracker.dispatchEvent(EventHandlerTracker.java:197) 	at org.eclipse.equinox.internal.event.EventHandlerTracker.dispatchEvent(EventHandlerTracker.java:1) 	at org.eclipse.osgi.framework.eventmgr.EventManager.dispatchEvent(EventManager.java:230) 	at org.eclipse.osgi.framework.eventmgr.ListenerQueue.dispatchEventSynchronous(ListenerQueue.java:148) 	at org.eclipse.equinox.internal.event.EventAdminImpl.dispatchEvent(EventAdminImpl.java:135) 	at org.eclipse.equinox.internal.event.EventAdminImpl.sendEvent(EventAdminImpl.java:78) 	at org.eclipse.equinox.internal.event.EventComponent.sendEvent(EventComponent.java:39) 	at org.eclipse.e4.ui.services.internal.events.EventBroker.send(EventBroker.java:80) 	at org.eclipse.e4.ui.internal.workbench.UIEventPublisher.notifyChanged(UIEventPublisher.java:58) 	at org.eclipse.emf.common.notify.impl.BasicNotifierImpl.eNotify(BasicNotifierImpl.java:374) 	at org.eclipse.e4.ui.model.application.impl.ContributionImpl.setObject(ContributionImpl.java:131) 	at org.eclipse.e4.ui.internal.workbench.addons.HandlerProcessingAddon.processActiveHandler(HandlerProcessingAddon.java:158) 	at org.eclipse.e4.ui.internal.workbench.addons.HandlerProcessingAddon.access$0(HandlerProcessingAddon.java:151) 	at org.eclipse.e4.ui.internal.workbench.addons.HandlerProcessingAddon$2.handleEvent(HandlerProcessingAddon.java:120) 	at org.eclipse.e4.ui.services.internal.events.UIEventHandler$1.run(UIEventHandler.java:41) 	at org.eclipse.swt.widgets.Synchronizer.syncExec(Synchronizer.java:180) 	at org.eclipse.ui.internal.UISynchronizer.syncExec(UISynchronizer.java:150) 	at org.eclipse.swt.widgets.Display.syncExec(Display.java:4688) 	at org.eclipse.e4.ui.internal.workbench.swt.E4Application$1.syncExec(E4Application.java:205) 	at org.eclipse.e4.ui.services.internal.events.UIEventHandler.handleEvent(UIEventHandler.java:38) 	at org.eclipse.equinox.internal.event.EventHandlerWrapper.handleEvent(EventHandlerWrapper.java:197) 	at org.eclipse.equinox.internal.event.EventHandlerTracker.dispatchEvent(EventHandlerTracker.java:197) 	at org.eclipse.equinox.internal.event.EventHandlerTracker.dispatchEvent(EventHandlerTracker.java:1) 	at org.eclipse.osgi.framework.eventmgr.EventManager.dispatchEvent(EventManager.java:230) 	at org.eclipse.osgi.framework.eventmgr.ListenerQueue.dispatchEventSynchronous(ListenerQueue.java:148) 	at org.eclipse.equinox.internal.event.EventAdminImpl.dispatchEvent(EventAdminImpl.java:135) 	at org.eclipse.equinox.internal.event.EventAdminImpl.sendEvent(EventAdminImpl.java:78) 	at org.eclipse.equinox.internal.event.EventComponent.sendEvent(EventComponent.java:39) 	at org.eclipse.e4.ui.services.internal.events.EventBroker.send(EventBroker.java:80) 	at org.eclipse.e4.ui.internal.workbench.UIEventPublisher.notifyChanged(UIEventPublisher.java:58) 	at org.eclipse.emf.common.notify.impl.BasicNotifierImpl.eNotify(BasicNotifierImpl.java:374) 	at org.eclipse.e4.ui.model.application.ui.basic.impl.PartImpl.setContext(PartImpl.java:399) 	at org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine.safeCreateGui(PartRenderingEngine.java:614) 	at org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine.safeCreateGui(PartRenderingEngine.java:735) 	at org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine.access$2(PartRenderingEngine.java:706) 	at org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine$7.run(PartRenderingEngine.java:700) 	at org.eclipse.core.runtime.SafeRunner.run(SafeRunner.java:42) 	at org.eclipse.e4.ui.internal.workbench.swt.PartRenderingEngine.createGui(PartRenderingEngine.java:685) 	at org.eclipse.e4.ui.workbench.renderers.swt.StackRenderer.showTab(StackRenderer.java:1096) 	at org.eclipse.e4.ui.workbench.renderers.swt.LazyStackRenderer$1.handleEvent(LazyStackRenderer.java:66) 	at org.eclipse.e4.ui.services.internal.events.UIEventHandler$1.run(UIEventHandler.java:41) 	at org.eclipse.swt.widgets.Synchronizer.syncExec(Synchronizer.java:180) 	at org.eclipse.ui.internal.UISynchronizer.syncExec(UISynchronizer.java:150) 	at org.eclipse.swt.widgets.Display.syncExec(Display.java:4688) 	at org.eclipse.e4.ui.internal.workbench.swt.E4Application$1.syncExec(E4Application.java:205) 	at org.eclipse.e4.ui.services.internal.events.UIEventHandler.handleEvent(UIEventHandler.java:38) 	at org.eclipse.equinox.internal.event.EventHandlerWrapper.handleEvent(EventHandlerWrapper.java:197) 	at org.eclipse.equinox.internal.event.EventHandlerTracker.dispatchEvent(EventHandlerTracker.java:197) 	at org.eclipse.equinox.internal.event.EventHandlerTracker.dispatchEvent(EventHandlerTracker.java:1) 	at org.eclipse.osgi.framework.eventmgr.EventManager.dispatchEvent(EventManager.java:230) 	at org.eclipse.osgi.framework.eventmgr.ListenerQueue.dispatchEventSynchronous(ListenerQueue.java:148) 	at org.eclipse.equinox.internal.event.EventAdminImpl.dispatchEvent(EventAdminImpl.java:135) 	at org.eclipse.equinox.internal.event.EventAdminImpl.sendEvent(EventAdminImpl.java:78) 	at org.eclipse.equinox.internal.event.EventComponent.sendEvent(EventComponent.java:39) 	at org.eclipse.e4.ui.services.internal.events.EventBroker.send(EventBroker.java:80) 	at org.eclipse.e4.ui.internal.workbench.UIEventPublisher.notifyChanged(UIEventPublisher.java:58) 	at org.eclipse.emf.common.notify.impl.BasicNotifierImpl.eNotify(BasicNotifierImpl.java:374) 	at org.eclipse.e4.ui.model.application.ui.impl.ElementContainerImpl.setSelectedElement(ElementContainerImpl.java:171) 	at org.eclipse.e4.ui.internal.workbench.ModelServiceImpl.showElementInWindow(ModelServiceImpl.java:576) 	at org.eclipse.e4.ui.internal.workbench.ModelServiceImpl.bringToTop(ModelServiceImpl.java:543) 	at org.eclipse.e4.ui.internal.workbench.PartServiceImpl.delegateBringToTop(PartServiceImpl.java:605) 	at org.eclipse.e4.ui.internal.workbench.PartServiceImpl.activate(PartServiceImpl.java:585) 	at org.eclipse.e4.ui.internal.workbench.PartServiceImpl.activate(PartServiceImpl.java:539) 	at org.eclipse.e4.ui.internal.workbench.PartServiceImpl.activate(PartServiceImpl.java:528) 	at org.eclipse.e4.ui.internal.workbench.PartServiceImpl.showPart(PartServiceImpl.java:1021) 	at reproducebug.ShowExamplePartHandler.execute(ShowExamplePartHandler.java:20) ... <snip> -------------------------------------------------------- I have attached a plugin project that reproduces the exception. Simply run the ReproduceBug.product file, add any required plugin dependencies to the created Run Configuration, and re-run. The cause of the issue is due to the cast of the object returned from the event.getProperty() function on line 4957 of WorkbenchPage.java. It is assumed that the object returned will be an instance of MUIElement, but HandlerImpl implements MApplicationElement and not MUIElement. There is no reason why the element object should be cast at all, since the if statement checks if the element is an instanceof MPart 2 lines down.