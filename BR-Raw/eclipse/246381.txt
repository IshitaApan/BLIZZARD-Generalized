[GlobalActions] GlobalUndoAction / GlobalRedoAction causes NPE by unsafely disposing old delegate

+++ This bug was initially created as a clone of Bug #235379 +++ Build ID: I20080523-0100 Steps To Reproduce: My GMF (1.0.3 ) based diagram editor shows program call graph. Node represents a procedure in a source code, line represents a call relationship. User can double click a node to open the source code in a LPEX text editor. A NPE occurs if user does some tasks involving opening source in text editor, closing it, switching back and forth between text editor and diagram editor. It happens randomly but can frequently reproduced with the interaction which intertwines PartService's firePartActivated, firePartClosed events. For example: 1. launch the diagram 2. double click on a node representing a procedure from source file A to automatically open source A in a text editor 3. close the text editor and switch back to the diagram 4. double click on another node representing a procedure from A to open the editor for A. 5. switch back to diagram editor 6. double click on a node from source file B to open source file B 7. close text editor for source B and switch back to diagram 8. double click on another node representing a procedure form source file B to open source file B A NPE is thrown because OperationHistoryActionHandler$PartListener has a null site when calling partClosed(). More information: Here is stack trace: !ENTRY org.eclipse.ui.workbench 4 2 2008-01-23 09:50:09.695 !MESSAGE Problems occurred when invoking code from plug-in: "org.eclipse.ui.workbench". !STACK 0 java.lang.NullPointerException 	at org.eclipse.ui.operations.OperationHistoryActionHandler$PartListener.partClosed(Unknown Source) 	at org.eclipse.ui.internal.PartListenerList$3.run(Unknown Source) 	at org.eclipse.core.runtime.SafeRunner.run(Unknown Source) 	at org.eclipse.core.runtime.Platform.run(Unknown Source) 	at org.eclipse.ui.internal.PartListenerList.fireEvent(Unknown Source) 	at org.eclipse.ui.internal.PartListenerList.firePartClosed(Unknown Source) 	at org.eclipse.ui.internal.PartService.firePartClosed(Unknown Source) 	at org.eclipse.ui.internal.WorkbenchPagePartList.firePartClosed(Unknown Source) 	at org.eclipse.ui.internal.PartList.partClosed(Unknown Source) 	at org.eclipse.ui.internal.PartList.removePart(Unknown Source) 	at org.eclipse.ui.internal.WorkbenchPage.disposePart(Unknown Source) 	at org.eclipse.ui.internal.WorkbenchPage.handleDeferredEvents(Unknown Source) 	at org.eclipse.ui.internal.WorkbenchPage.deferUpdates(Unknown Source) 	at org.eclipse.ui.internal.WorkbenchPage.closeEditors(Unknown Source) 	at org.eclipse.ui.internal.WorkbenchPage.closeEditor(Unknown Source) 	at org.eclipse.ui.internal.EditorPane.doHide(Unknown Source) 	at org.eclipse.ui.internal.PartStack.close(Unknown Source) 	at org.eclipse.ui.internal.EditorStack.close(Unknown Source) 	at org.eclipse.ui.internal.PartStack$1.close(Unknown Source) 	at org.eclipse.ui.internal.presentations.util.TabbedStackPresentation$1.handleEvent(Unknown Source) 	at org.eclipse.ui.internal.presentations.util.AbstractTabFolder.fireEvent(Unknown Source) 	at org.eclipse.ui.internal.presentations.util.AbstractTabFolder.fireEvent(Unknown Source) 	at org.eclipse.ui.internal.presentations.defaultpresentation.DefaultTabFolder.access$1(Unknown Source) 	at org.eclipse.ui.internal.presentations.defaultpresentation.DefaultTabFolder$1.closeButtonPressed(Unknown Source) 	at org.eclipse.ui.internal.presentations.PaneFolder.notifyCloseListeners(Unknown Source) 	at org.eclipse.ui.internal.presentations.PaneFolder$3.close(Unknown Source) 	at org.eclipse.swt.custom.CTabFolder.onMouse(Unknown Source) 	at org.eclipse.swt.custom.CTabFolder$1.handleEvent(Unknown Source) 	at org.eclipse.swt.widgets.EventTable.sendEvent(Unknown Source) 	at org.eclipse.swt.widgets.Widget.sendEvent(Unknown Source) 	at org.eclipse.swt.widgets.Display.runDeferredEvents(Unknown Source) 	at org.eclipse.swt.widgets.Display.readAndDispatch(Unknown Source) 	at org.eclipse.ui.internal.Workbench.runEventLoop(Unknown Source) 	at org.eclipse.ui.internal.Workbench.runUI(Unknown Source) 	at org.eclipse.ui.internal.Workbench.createAndRunWorkbench(Unknown Source) 	at org.eclipse.ui.PlatformUI.createAndRunWorkbench(Unknown Source) 	at org.eclipse.ui.internal.ide.IDEApplication.run(Unknown Source) 	at org.eclipse.core.internal.runtime.PlatformActivator$1.run(Unknown Source) 	at org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.runApplication(Unknown Source) 	at org.eclipse.core.runtime.internal.adaptor.EclipseAppLauncher.start(Unknown Source) 	at org.eclipse.core.runtime.adaptor.EclipseStarter.run(Unknown Source) 	at org.eclipse.core.runtime.adaptor.EclipseStarter.run(Unknown Source) 	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) 	at sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source) 	at sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source) 	at java.lang.reflect.Method.invoke(Unknown Source) 	at org.eclipse.core.launcher.Main.invokeFramework(Unknown Source) 	at org.eclipse.core.launcher.Main.basicRun(Unknown Source) 	at org.eclipse.core.launcher.Main.run(Unknown Source) 	at org.eclipse.core.launcher.Main.main(Unknown Source) Investigation: After some investigation, it looks to me that GlobalUndoAction's dispose of old delegate causes the problem. GlobalRedoAction has similar problem. Please see the trace at the bottom for event sequences. When PartService fires part activated event for newly opened text editor, GlobalUndoAction is notified. It calls setWorkbenchPart() which calls initializeWithContext(). As part of initialization of context, nitializeWithContext() disposes the old delegate which is a UndoActionHandler. See the following code: protected void initializeWithContext(IUndoContext context) { 		if (delegate != null) { 			delegate.removePropertyChangeListener(getDelegateListener()); 			delegate.dispose(); 			delegate = null; 		} ... When delegate (UndoActionHandler ) disposes itself, it removes enclosed part listener from workbench page. More importantly, it sets the site variable as null. However, the PartService gets listener list from org.eclipse.core.runtime.ListenerList which is a snapshot of workbenchpage part listeners. Although delegate does remove itself from part listener list, sometimes it is too late to by picked up by others. When partClosed and partActivated events are intertwined, depending on the runtime order, PartService.firePartClosed() may use the listener list which is got before delegate removes its part listener. When this invalid part listener receives the partClosed event, it still tries to handle it: if (part.equals(site.getPart())){...} Because its site has been set as null, as part of dispose happened before, an NPE occurs. Open other editor from diagram is a very useful feature. I foresee many GMF based editors will have this, so fixing this problem will be greatly appreciated. The following trace is captured when the NPE occurs. It shows a) intertwines of part activated and part closed events. b) the invalid part listener is still in use even though it is removed by delegate's dispose. Note the part listener OperationHistoryActionHandler$PartListener@18c018c is removed but it is still in the list used by fireClosed(), as shown at bottom of the trace ====> PartService firePartActivated from PartService: org.eclipse.ui.internal.PartService@49444944 ====> in PartListenerList.firePartActivated for APPORDENTR.RPGLE firePartActivated: PartListenerList = org.eclipse.ui.internal.PartListenerList@494c494c firePartActivated: listeners = [Ljava.lang.Object;@20f420f4 size=65 firePartActivated listener[0]: com.ibm.etools.systems.core.ui.view.SystemViewPart$1@4a2a4a2a firePartActivated listener[1]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@76507650 ***OperationHistoryActionHandler:page= org.eclipse.ui.internal.WorkbenchPage@4020402 *** remove partListener= org.eclipse.ui.operations.OperationHistoryActionHandler$PartListener@18c018c *** Site set as NULL org.eclipse.ui.operations.UndoActionHandler@1760176 firePartActivated listener[2]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@8e608e6 ***OperationHistoryActionHandler:page= org.eclipse.ui.internal.WorkbenchPage@4020402 *** remove partListener= org.eclipse.ui.operations.OperationHistoryActionHandler$PartListener@cea0cea *** Site set as NULL org.eclipse.ui.operations.RedoActionHandler@cd40cd4 firePartActivated listener[3]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@9c209c2 firePartActivated listener[4]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@1f161f16 firePartActivated listener[5]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@2dde2dde firePartActivated listener[6]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@3e0c3e0c firePartActivated listener[7]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@4cd64cd6 firePartActivated listener[8]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@5ec05ec0 firePartActivated listener[9]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@6fac6fac firePartActivated listener[10]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@7e807e80 firePartActivated listener[11]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@7a0c7a0c firePartActivated listener[12]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@48cc48cc firePartActivated listener[13]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@7dfc7dfc firePartActivated listener[14]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@2da42da4 firePartActivated listener[15]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@20342034 firePartActivated listener[16]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@28942894 firePartActivated listener[17]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@60fe60fe firePartActivated listener[18]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@57a057a firePartActivated listener[19]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@11f611f6 firePartActivated listener[20]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@5e7e5e7e firePartActivated listener[21]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@71407140 firePartActivated listener[22]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@1a881a88 firePartActivated listener[23]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@29782978 firePartActivated listener[24]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@3a5a3a5a firePartActivated listener[25]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@3ea03ea0 firePartActivated listener[26]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@43144314 firePartActivated listener[27]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@475c475c firePartActivated listener[28]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@5d805d80 firePartActivated listener[29]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@65c265c2 firePartActivated listener[30]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@9800980 firePartActivated listener[31]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@34603460 firePartActivated listener[32]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@3cfa3cfa firePartActivated listener[33]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@41664166 firePartActivated listener[34]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@70b670b6 firePartActivated listener[35]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@548e548e firePartActivated listener[36]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@5d2a5d2a firePartActivated listener[37]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@65b865b8 firePartActivated listener[38]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@6e606e60 firePartActivated listener[39]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@773a773a firePartActivated listener[40]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@17701770 firePartActivated listener[41]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@1bd81bd8 firePartActivated listener[42]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@20402040 firePartActivated listener[43]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@24aa24aa firePartActivated listener[44]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@38643864 firePartActivated listener[45]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@3ff83ff8 firePartActivated listener[46]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@484a484a firePartActivated listener[47]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@561e561e firePartActivated listener[48]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@5e205e20 firePartActivated listener[49]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@6fa86fa8 firePartActivated listener[50]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@310e310e firePartActivated listener[51]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@40824082 firePartActivated listener[52]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@702c702c firePartActivated listener[53]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$1@1e121e12 firePartActivated listener[54]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@4e204e20 firePartActivated listener[55]: org.eclipse.gmf.runtime.diagram.ui.printing.render.providers.DiagramWithPrintGlobalActionHandlerProvider$1@588c588c firePartActivated listener[56]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@65b865b8 firePartActivated listener[57]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@98e098e firePartActivated listener[58]: org.eclipse.gmf.runtime.common.ui.action.AbstractActionHandler$2@48844884 firePartActivated listener[59]: org.eclipse.ui.internal.PagePartSelectionTracker@484c484c firePartActivated listener[60]: com.ibm.etools.systems.editor.internal.SystemAutosaveController$1@23bc23bc firePartActivated listener[61]: com.ibm.etools.iseries.core.resources.ISeriesEditableSrcPhysicalFileMember@3c4e3c4e firePartActivated listener[62]: com.ibm.etools.iseries.core.resources.ISeriesEditableSrcPhysicalFileMember@77587758 firePartActivated listener[63]: org.eclipse.ui.operations.OperationHistoryActionHandler$PartListener@18c018c ===> in OperationHistoryActionHandler:partActivated for APPORDENTR.RPGLE ====> partActivated partListener= org.eclipse.ui.operations.OperationHistoryActionHandler$PartListener@18c018c firePartActivated listener[64]: org.eclipse.ui.operations.OperationHistoryActionHandler$PartListener@cea0cea ===> in OperationHistoryActionHandler:partActivated for APPORDENTR.RPGLE ====> partActivated partListener= org.eclipse.ui.operations.OperationHistoryActionHandler$PartListener@cea0cea firePartClosed listener[63]: org.eclipse.gmf.runtime.common.ui.action.AbstractContributionItem$1@7b0a7b0a firePartClosed listener[64]: org.eclipse.gmf.runtime.common.ui.action.AbstractContributionItem$1@5260526 firePartClosed listener[65]: org.eclipse.gmf.runtime.common.ui.action.AbstractContributionItem$1@738c738c firePartClosed listener[66]: org.eclipse.gmf.runtime.common.ui.action.AbstractContributionItem$1@3ae43ae4 firePartClosed listener[67]: org.eclipse.gmf.runtime.common.ui.action.AbstractContributionItem$1@481e481e firePartClosed listener[68]: org.eclipse.gmf.runtime.common.ui.action.AbstractContributionItem$1@1fc41fc4 firePartClosed listener[69]: org.eclipse.gmf.runtime.common.ui.action.AbstractContributionItem$1@43be43be firePartClosed listener[70]: org.eclipse.gmf.runtime.common.ui.action.AbstractContributionItem$1@2ee02ee0 firePartClosed listener[71]: org.eclipse.gmf.runtime.common.ui.action.AbstractContributionItem$1@73e873e8 firePartClosed listener[72]: org.eclipse.ui.operations.OperationHistoryActionHandler$PartListener@18c018c ====>in OperationHistoryActionHandler:Site is NULL org.eclipse.ui.operations.UndoActionHandler@1760176 ====> partListener= org.eclipse.ui.operations.OperationHistoryActionHandler$PartListener@18c018c