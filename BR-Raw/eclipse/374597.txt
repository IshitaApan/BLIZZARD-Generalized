[Compatibility] ClassCastException when adding pure 4.x view to 3.x perspective running in compatibility mode

Build Identifier: 4.2M6 We are migrating an RCP application to 4.x and have to use the compatibility layer since we rely on a GEF editor. Several views can however be migrated to be "pure" 4.x views. I have found that I can add our clean parts as PartDescriptors in a customized "LegacyIDE.e4xmi". In the PerspectiveFactory I have also been able to add the view using IFolderLayout.addView(String idOfPurePart) The problem I had to fix was that in WorkbenchPartReference.java (org.eclipse.ui.workbench) I had to check if the part is a compatibility part before the cast is done, see below for the change that fixes my problem: 			// check if we were actually created, it is insufficient to check 			// whether the 'object' feature is valid or not because it is one of 			// the last things to be unset during the teardown process, this 			// means we may return a valid workbench part even if it is actually 			// in the process of being destroyed, see bug 328944 			if (part.getWidget() != null) { 				Object object = part.getObject(); 				if (object instanceof CompatibilityPart) { 					CompatibilityPart compatibilityPart = (CompatibilityPart) object; 					legacyPart = compatibilityPart.getPart(); 				} 			} I have seen this type of check in other parts of the e4 code. Reproducible: Always